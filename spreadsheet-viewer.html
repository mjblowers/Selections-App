<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spreadsheet Row Selector</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-section {
            margin-bottom: 14px;
            text-align: center;
        }

        .file-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .file-btn {
            background: #667eea;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            font-size: 15px;
        }

        .file-btn.secondary {
            background: #5568d3;
        }

        .file-name {
            margin-top: 6px;
            color: #666;
            font-size: 14px;
        }

        .error {
            color: #e74c3c;
            text-align: center;
            margin-top: 10px;
        }

        /* House row */
        .house-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .house-input {
            flex: 1;
            display: flex;
            gap: 8px;
            align-items: center;
            min-width: 240px;
        }

        #houseNameInput {
            flex: 1;
            padding: 10px 12px;
            border-radius: 6px;
            border: 2px solid #ddd;
            font-size: 16px;
        }

        #houseNameInput:disabled {
            background: #f3f4f6;
            color: #444;
        }

        .confirm-btn,
        .edit-btn {
            padding: 10px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .confirm-btn {
            background: #2ecc71;
            color: white;
        }

        .edit-btn {
            background: #f1c40f;
            color: #111;
        }

        .floor-plan-select,
        .spec-select {
            min-width: 180px;
            padding: 10px 12px;
            border-radius: 6px;
            border: 2px solid #ddd;
            background: white;
        }

        .spec-block {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 180px;
        }
        .toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }
        .toggle-btn {
            padding: 8px 10px;
            border-radius: 6px;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 13px;
        }
        .toggle-btn.active {
            background: #667eea;
            color: white;
            border-color: #5568d3;
        }

        .selector-section {
            display: none;
            margin-top: 20px;
        }

        .selector-section.active {
            display: block;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .row-details {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
        }

        .row-details.active {
            display: block;
        }

        .row-details h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .detail-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }

        .detail-label {
            font-weight: 600;
            color: #667eea;
        }

        .detail-value {
            color: #333;
        }

        .assign-row {
            margin-top: 16px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .assign-row select {
            flex: 1;
            margin: 0;
        }

        .assign-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .assign-btn:hover {
            background: #28b463;
        }

        .selected-items {
            margin-top: 30px;
            display: none;
        }

        .selected-items.active {
            display: block;
        }

        .room-section {
            margin-bottom: 18px;
        }

        /* Tabs for rooms */
        .room-tabs {
            display: flex;
            gap: 6px;
            margin-left: 12px;
            flex-wrap: wrap;
        }
        .room-tab-btn {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
        }
        .room-tab-btn.active {
            background: #667eea;
            color: #fff;
            border-color: #5568d3;
        }
        .room-tab-content {
            margin-top: 12px;
        }

        .room-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .selected-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .selected-item-content {
            flex: 1;
            min-width: 0;
        }

        .selected-item-summary {
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .selected-item-details {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        @media (max-width:800px) {
            .house-row {
                flex-direction: column;
                align-items: stretch;
            }

            .floor-plan-select,
            .spec-select {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ðŸ“Š Selection Selector Appy App</h1>

        <div class="upload-section">
            <div class="file-buttons">
                <button id="startScratchBtn" class="file-btn">Select Data Source</button>
                <!-- <button id="existingSpecBtn" class="file-btn secondary">Choose existing spec</button> -->
                <button id="newProjectBtn" class="file-btn" style="background: #e74c3c;">Clear Data</button>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" />
            <div class="file-name" id="fileName"></div>
            <div class="error" id="error"></div>
            <div id="debugOutput" style="margin-top:8px;background:#f3f4f6;padding:8px;border-radius:6px;font-size:12px;color:#333;max-height:120px;overflow:auto;display:none;"></div>
        </div>

        <!-- House name + Floor Plan row -->
        <div class="house-row">
            <div class="house-input">
                <input id="houseNameInput" type="text" placeholder="Enter house name" />
                <button id="confirmHouseBtn" class="confirm-btn">Confirm</button>
                <button id="editHouseBtn" class="edit-btn" style="display:none;">Edit</button>
            </div>
            <select id="floorPlanSelect" class="floor-plan-select" aria-label="Floor Plan">
                <option value="">-- Floor Plan --</option>
                <option value="Olympia">Olympia</option>
                <option value="Oakley">Oakley</option>
                <option value="MGM Grand">MGM Grand</option>
            </select>

            <div class="spec-block" style="margin-left:12px;">
                <label style="font-weight:600; margin-bottom:6px;">Beds / Baths</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <input id="bedsInput" type="number" min="0" placeholder="Beds" style="padding:8px;width:80px;border-radius:6px;border:2px solid #ddd;" />
                    <input id="bathsInput" type="number" min="0" placeholder="Baths" style="padding:8px;width:80px;border-radius:6px;border:2px solid #ddd;" />
                    <button id="setBedsBtn" class="file-btn" style="padding:8px 10px;font-size:13px;">Set House Layout</button>
                    <button id="editBedsBtn" class="file-btn secondary" style="display:none;padding:8px 10px;font-size:13px;">Edit House Layout</button>
                </div>
                <label style="font-weight:600; margin-top:8px;">Extra Rooms (toggle)</label>
                <div class="toggle-group" id="extraRoomsGroup">
                    <button type="button" class="toggle-btn" data-room="Office">Office</button>
                    <button type="button" class="toggle-btn" data-room="Den">Den</button>
                    <button type="button" class="toggle-btn" data-room="Living">Living</button>
                    <button type="button" class="toggle-btn" data-room="Dining">Dining</button>
                    <button type="button" class="toggle-btn" data-room="Family">Family</button>
                    <button type="button" class="toggle-btn" data-room="Garage">Garage</button>
                </div>
            </div>
        </div>

        <div class="selector-section" id="selectorSection">
            <label for="rowSelect">Select an Item:</label>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <select id="rowSelect">
                    <option value="">-- Choose a row --</option>
                </select>
                <select id="subsectionSelect" style="min-width: 150px;">
                    <option value="Subsection 1">Subsection 1</option>
                    <option value="Subsection 2">Subsection 2</option>
                    <option value="Subsection 3">Subsection 3</option>
                </select>
                <button id="confirmSelectionBtn" class="assign-btn" style="background:#5568d3;" onclick="handleAssignToCurrentRoom(); return false;">Confirm Selection</button>
            </div>
        </div>

        <div class="row-details" id="rowDetails">
            <h3>Row Details</h3>
            <div id="detailsContent"></div>

            <div class="assign-row">
                <select id="roomSelect">
                    <option value="">-- Choose a room --</option>
                </select>
                <button id="assignBtn" class="assign-btn">Assign to Room</button>
                <button id="assignCurrentBtn" class="assign-btn" style="background:#5568d3; margin-left:6px;">Add to Current Room</button>
            </div>
        </div>

        <div class="selected-items" id="selectedItems">
            <h3>Selected Room to Add Item</h3>
            <div style="display:flex; gap:8px; align-items:center;">
                <div id="roomTabs" class="room-tabs" aria-label="Room Tabs"></div>
            </div>
            <div id="roomTabContent" class="room-tab-content"></div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button id="exportBtn" class="file-btn" disabled>Export to Excel</button>
        </div>
    </div>

    <script>
        // base rooms (static) and dynamic bedroom/bathroom slots
        // NOTE: remove hard-coded miscellaneous rooms so only generated bedrooms, baths,
        // and user-selected extra rooms (toggle buttons) populate the room list.
        const baseRooms = [];
        let dynamicBedrooms = [];
        let dynamicBaths = [];
        // `rooms` will be built from baseRooms + dynamicBedrooms + dynamicBaths
        let rooms = [...baseRooms];

        let fileMode = 'scratch'; // 'scratch' or 'existing'
        let spreadsheetData = [];
        let headers = [];
        let selectedItems = [];
        let currentSelectedRow = null;

        // UI elements
        const startScratchBtn = document.getElementById('startScratchBtn');
        const existingSpecBtn = document.getElementById('existingSpecBtn');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const errorDiv = document.getElementById('error');

        const houseNameInput = document.getElementById('houseNameInput');
        const confirmHouseBtn = document.getElementById('confirmHouseBtn');
        const editHouseBtn = document.getElementById('editHouseBtn');
        const floorPlanSelect = document.getElementById('floorPlanSelect');
        // Beds/Baths inputs (from DOM)
        const bedsInput = document.getElementById('bedsInput');
        const bathsInput = document.getElementById('bathsInput');
        const setBedsBtn = document.getElementById('setBedsBtn');
        const editBedsBtn = document.getElementById('editBedsBtn');

        const selectorSection = document.getElementById('selectorSection');
        const rowSelect = document.getElementById('rowSelect');
        const rowDetails = document.getElementById('rowDetails');
        const detailsContent = document.getElementById('detailsContent');
        const roomSelect = document.getElementById('roomSelect');
        const assignBtn = document.getElementById('assignBtn');
        const assignCurrentBtn = document.getElementById('assignCurrentBtn');
        const confirmSelectionBtn = document.getElementById('confirmSelectionBtn');
        const selectedItemsSection = document.getElementById('selectedItems');
        const selectedItemsList = document.getElementById('selectedItemsList');

        const exportBtn = document.getElementById('exportBtn');

        // Debug helper (defined before populateRoomDropdown to avoid init ordering issues)
        const debugOutput = document.getElementById('debugOutput');
        function debugLog(msg) {
            try { console.log('[DEBUG]', msg); } catch (e) {}
            if (!debugOutput) return;
            debugOutput.style.display = 'block';
            const time = new Date().toLocaleTimeString();
            const el = document.createElement('div');
            el.textContent = `[${time}] ${msg}`;
            debugOutput.appendChild(el);
            // keep only latest 2000 chars
            if (debugOutput.textContent.length > 2000) {
                debugOutput.removeChild(debugOutput.firstChild);
            }
        }

        // Setup initial room dropdown
        populateRoomDropdown();

        // Load saved state from localStorage
        loadState();

        // Event listeners
        if (startScratchBtn) {
            startScratchBtn.addEventListener('click', () => {
                fileMode = 'scratch';
                fileInput.value = '';
                fileInput.click();
            });
        }
        if (existingSpecBtn) {
            existingSpecBtn.addEventListener('click', () => {
                fileMode = 'existing';
                fileInput.value = '';
                fileInput.click();
            });
        }
        if (fileInput) fileInput.addEventListener('change', handleFileUpload);

        if (rowSelect) rowSelect.addEventListener('change', handleRowSelect);
        if (assignBtn) assignBtn.addEventListener('click', handleAssignToRoom);
        if (assignCurrentBtn) assignCurrentBtn.addEventListener('click', handleAssignToCurrentRoom);
        if (confirmSelectionBtn) {
            confirmSelectionBtn.addEventListener('click', handleAssignToCurrentRoom);
        }
        if (confirmHouseBtn) confirmHouseBtn.addEventListener('click', handleConfirmHouse);
        if (editHouseBtn) editHouseBtn.addEventListener('click', handleEditHouse);
        if (setBedsBtn) setBedsBtn.addEventListener('click', handleSetBedsBaths);
        if (editBedsBtn) editBedsBtn.addEventListener('click', handleEditBedsBaths);
        // extra room toggles
        document.addEventListener('click', function (e) {
            if (e.target && e.target.classList && e.target.classList.contains('toggle-btn')) {
                const btn = e.target;
                if (btn.disabled) return;
                btn.classList.toggle('active');
            }
        });
        exportBtn.addEventListener('click', exportToExcel);

        // localStorage functions
        function saveState() {
            const state = {
                selectedItems: selectedItems,
                dynamicBedrooms: dynamicBedrooms,
                dynamicBaths: dynamicBaths,
                selectedExtraRooms: window.selectedExtraRooms || [],
                houseName: houseNameInput.value,
                floorPlan: floorPlanSelect.value,
                beds: bedsInput.value,
                baths: bathsInput.value,
                activeRoomTab: window.activeRoomTab,
                spreadsheetData: spreadsheetData,
                headers: headers,
                lastFileName: document.getElementById('fileName').textContent
            };
            localStorage.setItem('selectionAppState', JSON.stringify(state));
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('selectionAppState');
                if (!saved) return; // no saved state

                const state = JSON.parse(saved);

                // restore selections
                selectedItems = state.selectedItems || [];
                dynamicBedrooms = state.dynamicBedrooms || [];
                dynamicBaths = state.dynamicBaths || [];
                window.selectedExtraRooms = state.selectedExtraRooms || [];

                // restore house config
                houseNameInput.value = state.houseName || '';
                floorPlanSelect.value = state.floorPlan || '';
                bedsInput.value = state.beds || '';
                bathsInput.value = state.baths || '';

                // if beds/baths were set, lock the inputs and rebuild rooms
                if ((state.beds && state.beds > 0) || (state.baths && state.baths > 0) || (state.selectedExtraRooms && state.selectedExtraRooms.length > 0)) {
                    bedsInput.disabled = true;
                    bathsInput.disabled = true;
                    document.querySelectorAll('#extraRoomsGroup .toggle-btn').forEach(b => b.disabled = true);
                    setBedsBtn.style.display = 'none';
                    editBedsBtn.style.display = 'inline-block';

                    // restore toggle states
                    document.querySelectorAll('#extraRoomsGroup .toggle-btn').forEach(btn => {
                        const room = btn.getAttribute('data-room');
                        if (state.selectedExtraRooms && state.selectedExtraRooms.includes(room)) {
                            btn.classList.add('active');
                        }
                    });

                    // rebuild rooms array
                    updateRoomsArray();
                }

                // restore house name disabled state if it was confirmed
                if (state.houseName) {
                    houseNameInput.disabled = true;
                    confirmHouseBtn.style.display = 'none';
                    editHouseBtn.style.display = 'inline-block';
                }

                // restore active tab
                if (state.activeRoomTab) {
                    window.activeRoomTab = state.activeRoomTab;
                }

                // restore spreadsheet data and headers
                spreadsheetData = state.spreadsheetData || [];
                headers = state.headers || [];
                
                // restore file name display
                if (state.lastFileName) {
                    document.getElementById('fileName').textContent = state.lastFileName;
                }
                
                // repopulate the row dropdown if we have spreadsheet data
                if (spreadsheetData.length > 0) {
                    populateDropdown();
                    document.getElementById('selectorSection').classList.add('active');
                }

                // if there are selected items, display them
                if (selectedItems.length > 0) {
                    displaySelectedItems();
                }
            } catch (err) {
                console.error('Error loading state:', err);
                // silently fail; user continues with blank slate
            }
        }

        function clearState() {
            localStorage.removeItem('selectionAppState');
            // reset form
            selectedItems = [];
            dynamicBedrooms = [];
            dynamicBaths = [];
            window.selectedExtraRooms = [];
            houseNameInput.value = '';
            houseNameInput.disabled = false;
            confirmHouseBtn.style.display = 'inline-block';
            editHouseBtn.style.display = 'none';
            floorPlanSelect.value = '';
            bedsInput.value = '';
            bedsInput.disabled = false;
            bathsInput.value = '';
            bathsInput.disabled = false;
            setBedsBtn.style.display = 'inline-block';
            editBedsBtn.style.display = 'none';
            document.querySelectorAll('#extraRoomsGroup .toggle-btn').forEach(b => {
                b.disabled = false;
                b.classList.remove('active');
            });
            rooms = [...baseRooms];
            populateRoomDropdown();
            selectorSection.classList.remove('active');
            rowDetails.classList.remove('active');
            selectedItemsSection.classList.remove('active');
            rowSelect.innerHTML = '<option value="">-- Choose a row --</option>';
            spreadsheetData = [];
            headers = [];
            currentSelectedRow = null;
            errorDiv.textContent = '';
            fileName.textContent = '';
        }

        // Add "New Project" button listener
        const newProjectBtn = document.getElementById('newProjectBtn');
        if (newProjectBtn) {
            newProjectBtn.addEventListener('click', function() {
                if (confirm('Start a new project? This will clear all current selections. Continue?')) {
                    clearState();
                }
            });
        }


        function handleConfirmHouse() {
            const name = houseNameInput.value.trim();
            if (!name) {
                errorDiv.textContent = 'Please enter a house name before confirming.';
                return;
            }
            errorDiv.textContent = '';
            houseNameInput.disabled = true;
            confirmHouseBtn.style.display = 'none';
            editHouseBtn.style.display = 'inline-block';
            saveState();
        }

        function handleEditHouse() {
            houseNameInput.disabled = false;
            houseNameInput.focus();
            editHouseBtn.style.display = 'none';
            confirmHouseBtn.style.display = 'inline-block';
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            fileName.textContent = `Selected: ${file.name}`;
            errorDiv.textContent = '';

            const reader = new FileReader();
            reader.onload = function (ev) {
                try {
                    const data = new Uint8Array(ev.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    if (jsonData.length < 2) {
                        throw new Error('Spreadsheet must have at least a header row and one data row');
                    }

                    headers = jsonData[0];
                    spreadsheetData = jsonData.slice(1).map((row, index) => {
                        const rowObj = { _rowNumber: index + 2 };
                        headers.forEach((header, i) => {
                            rowObj[header] = row[i] !== undefined ? row[i] : '';
                        });
                        return rowObj;
                    });

                    populateDropdown();
                    selectorSection.classList.add('active');
                    rowDetails.classList.remove('active');

                    if (fileMode === 'existing') {
                        // Look for rows where column 1 (first column) matches a room name (case-insensitive)
                        const matches = [];
                        jsonData.slice(1).forEach((row, idx) => {
                            const col1 = row[0] !== undefined && row[0] !== null ? String(row[0]).trim() : '';
                            if (!col1) return;
                            const matchedRoom = rooms.find(r => r.toLowerCase() === col1.toLowerCase());
                            if (matchedRoom) {
                                const rowObj = { _rowNumber: idx + 2 };
                                headers.forEach((header, i) => {
                                    rowObj[header] = row[i] !== undefined ? row[i] : '';
                                });
                                rowObj.room = matchedRoom;
                                matches.push(rowObj);
                            }
                        });

                        if (matches.length === 0) {
                            errorDiv.textContent = 'No rows found with a room in column 1 matching known room types.';
                        } else {
                            matches.forEach(m => {
                                if (!selectedItems.some(si => si._rowNumber === m._rowNumber)) {
                                    selectedItems.push(m);
                                }
                            });
                            displaySelectedItems();

                            errorDiv.textContent = '';
                        }
                    }

                } catch (error) {
                    errorDiv.textContent = `Error: ${error.message}`;
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);

        }
        
        function updateRoomsArray() {
            // merge while avoiding duplicates and include any selected extra rooms
            const set = new Set();
            baseRooms.forEach(r => set.add(r));
            dynamicBedrooms.forEach(r => set.add(r));
            dynamicBaths.forEach(r => set.add(r));
            if (window.selectedExtraRooms && Array.isArray(window.selectedExtraRooms)) {
                window.selectedExtraRooms.forEach(r => set.add(r));
            }
            rooms = Array.from(set);
            populateRoomDropdown();
            // ensure display updates to show empty room sections if needed
            displaySelectedItems();
        }

        function handleSetBedsBaths() {
            const beds = parseInt(bedsInput.value, 10) || 0;
            const baths = parseInt(bathsInput.value, 10) || 0;
            if (beds < 0 || baths < 0) {
                errorDiv.textContent = 'Please enter valid non-negative numbers for beds and baths.';
                return;
            }
            errorDiv.textContent = '';

            dynamicBedrooms = Array.from({ length: beds }, (_, i) => `Bedroom ${i + 1}`);
            dynamicBaths = Array.from({ length: baths }, (_, i) => `Bath ${i + 1}`);

            // collect selected extra rooms from toggle buttons
            const extras = Array.from(document.querySelectorAll('#extraRoomsGroup .toggle-btn'))
                .filter(b => b.classList.contains('active'))
                .map(b => b.getAttribute('data-room'));
            window.selectedExtraRooms = extras;

            // lock inputs and toggle buttons
            bedsInput.disabled = true;
            bathsInput.disabled = true;
            document.querySelectorAll('#extraRoomsGroup .toggle-btn').forEach(b => b.disabled = true);
            setBedsBtn.style.display = 'none';
            editBedsBtn.style.display = 'inline-block';

            updateRoomsArray();
            saveState();
        }

        function handleEditBedsBaths() {
            bedsInput.disabled = false;
            bathsInput.disabled = false;
            document.querySelectorAll('#extraRoomsGroup .toggle-btn').forEach(b => b.disabled = false);
            setBedsBtn.style.display = 'inline-block';
            editBedsBtn.style.display = 'none';
            bedsInput.focus();
        }
        function exportToExcel() {
  if (!selectedItems || selectedItems.length === 0) {
    errorDiv.textContent = 'Nothing to export.';
    return;
  }

    // Determine data headers (fall back to headers captured from file)
    const dataHeaders = (headers && headers.length)
        ? headers.slice()
        : Array.from(new Set(selectedItems.flatMap(it => Object.keys(it))))
                .filter(k => k !== 'room' && k !== '_rowNumber' && k !== 'subsection');

    // Columns for export (no Subsection column â€” subsections will be row headers)
    const selectionCols = ['Room', '_rowNumber', ...dataHeaders];

  const wb = XLSX.utils.book_new();

  // Summary sheet
  const house = (houseNameInput && houseNameInput.value) ? houseNameInput.value : '';
  const floor = (floorPlanSelect && floorPlanSelect.value) ? floorPlanSelect.value : '';
  const spec = (document.getElementById('specSelect') && document.getElementById('specSelect').value) ? document.getElementById('specSelect').value : '';
  const summary = [
    ['House Name', house],
    ['Floor Plan', floor],
    ['Spec', spec],
    ['Exported At', new Date().toLocaleString()]
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'Summary');

  // All selections sheet
    const aoaAll = [selectionCols];
    selectedItems.forEach(item => {
        const row = selectionCols.map(col => {
            if (col === 'Room') return item.room || '';
            if (col === '_rowNumber') return item._rowNumber || '';
            return item[col] !== undefined ? item[col] : '';
        });
        aoaAll.push(row);
    });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoaAll), 'All Selections');

  // Group by room and create a sheet per room (and Unassigned)
  const grouped = {};
  rooms.forEach(r => grouped[r] = []);
  grouped['Unassigned'] = [];

  selectedItems.forEach(it => {
    const key = it.room && grouped[it.room] ? it.room : 'Unassigned';
    grouped[key].push(it);
  });

  const sanitizeSheetName = (name) => {
    const safe = String(name).replace(/[\/\\\?\*\[\]:]/g, '').slice(0, 31) || 'Sheet';
    return safe;
  };

    Object.keys(grouped).forEach(roomName => {
        const items = grouped[roomName];
        if (!items || items.length === 0) return;

        const aoa = [];
        const subsectionTitleRows = [];

        // Group items by subsection within the room
        const subsectionGroups = {};
        items.forEach(it => {
            const ss = it.subsection || 'Subsection 1';
            if (!subsectionGroups[ss]) subsectionGroups[ss] = [];
            subsectionGroups[ss].push(it);
        });

        // For each subsection, add a subsection title row, then column headers, then its items
        Object.keys(subsectionGroups).sort().forEach(subsection => {
            // Subsection title row (single cell)
            subsectionTitleRows.push(aoa.length);
            aoa.push([subsection]);
            // Column header for this subsection block
            aoa.push(selectionCols);
            subsectionGroups[subsection].forEach(item => {
                const row = selectionCols.map(col => {
                    if (col === 'Room') return item.room || '';
                    if (col === '_rowNumber') return item._rowNumber || '';
                    return item[col] !== undefined ? item[col] : '';
                });
                aoa.push(row);
            });
            // add an empty spacer row after each subsection for readability
            aoa.push([]);
        });

        const sheetName = sanitizeSheetName(roomName);
        const sheet = XLSX.utils.aoa_to_sheet(aoa);

        // Merge subsection title rows across all used columns for visual emphasis
        try {
            const lastCol = selectionCols.length - 1;
            sheet['!merges'] = sheet['!merges'] || [];
            subsectionTitleRows.forEach(rIdx => {
                sheet['!merges'].push({ s: { r: rIdx, c: 0 }, e: { r: rIdx, c: lastCol } });
                // Also attempt to set a simple text style; may be ignored by community writer
                const cellRef = XLSX.utils.encode_cell({ c: 0, r: rIdx });
                const cell = sheet[cellRef] || (sheet[cellRef] = { t: 's', v: '' });
                try {
                    cell.s = { font: { bold: true } };
                } catch (e) {
                    // ignore styling errors
                }
            });
        } catch (e) {
            console.warn('Could not apply merges/styles to export:', e);
        }

        XLSX.utils.book_append_sheet(wb, sheet, sheetName);
    });

  // Build file name and write
  const fileNameSafe = (house || 'Selections').replace(/[\/\\:?<>|*"]/g, '');
  const fileName = `${fileNameSafe} - ${floor || 'Plan'} - selections.xlsx`;
  XLSX.writeFile(wb, fileName);
}

        function populateDropdown() {
            rowSelect.innerHTML = '<option value="">-- Choose a row --</option>';
            spreadsheetData.forEach((row, index) => {
                const option = document.createElement('option');
                option.value = index;
                const displayValues = headers.slice(0, 3).map(h => row[h]).filter(v => v !== '');
                option.textContent = `Row ${row._rowNumber}: ${displayValues.join(' - ')}`;
                rowSelect.appendChild(option);
            });
        }

        function populateRoomDropdown() {
            roomSelect.innerHTML = '<option value="">-- Choose a room --</option>';
            rooms.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.textContent = r;
                roomSelect.appendChild(opt);
            });
            // If Select2 is active, refresh it to pick up the new options
            try {
                if (window.jQuery && jQuery.fn && jQuery.fn.select2) {
                    const $rs = jQuery(roomSelect);
                    if ($rs.data('select2')) {
                        $rs.select2('destroy');
                    }
                    $rs.select2({
                        placeholder: 'Search for a room...',
                        allowClear: true,
                        width: '100%'
                    });
                }
            } catch (err) {
                // ignore if select2 not present yet
            }
        }

        function handleRowSelect(e) {
            const selectedIndex = e.target.value;
            if (selectedIndex === '') {
                rowDetails.classList.remove('active');
                currentSelectedRow = null;
                if (confirmSelectionBtn) confirmSelectionBtn.disabled = true;
                return;
            }
            const selectedRow = spreadsheetData[selectedIndex];
            currentSelectedRow = selectedRow;
            displayRowDetails(selectedRow);

            if (confirmSelectionBtn) confirmSelectionBtn.disabled = false;

            const already = selectedItems.find(it => it._rowNumber === selectedRow._rowNumber);
            if (already) {
                roomSelect.value = already.room || '';
            } else {
                roomSelect.value = '';
            }
        }

        function displayRowDetails(row) {
            detailsContent.innerHTML = '';
            headers.forEach(header => {
                const detailItem = document.createElement('div');
                detailItem.className = 'detail-item';

                const label = document.createElement('span');
                label.className = 'detail-label';
                label.textContent = header;

                const value = document.createElement('span');
                value.className = 'detail-value';
                value.textContent = row[header] !== '' ? row[header] : '(empty)';

                detailItem.appendChild(label);
                detailItem.appendChild(value);
                detailsContent.appendChild(detailItem);
            });
            rowDetails.classList.add('active');
        }

        function handleAssignToRoom() {
            try {
                if (!currentSelectedRow) {
                    errorDiv.textContent = 'No row selected to assign.';
                    return;
                }
                const selectedRoom = roomSelect.value;
                if (!selectedRoom) {
                    errorDiv.textContent = 'Please choose a room.';
                    return;
                }
                errorDiv.textContent = '';

                const existsIndex = selectedItems.findIndex(it => it._rowNumber === currentSelectedRow._rowNumber);
                if (existsIndex !== -1) {
                    selectedItems[existsIndex].room = selectedRoom;
                } else {
                    const itemToAdd = { ...currentSelectedRow, room: selectedRoom };
                    selectedItems.push(itemToAdd);
                }

                displaySelectedItems();

                currentSelectedRow = null;
                rowDetails.classList.remove('active');
                rowSelect.value = '';
                try {
                    if (window.jQuery && jQuery.fn && jQuery.fn.select2) {
                        jQuery(rowSelect).val(null).trigger('change');
                    }
                } catch (e) {
                    // ignore
                }
                roomSelect.value = '';
                saveState();
            } catch (err) {
                console.error(err);
                errorDiv.textContent = 'Error during assign: ' + (err && err.message ? err.message : err);
            }
        }

        function handleAssignToCurrentRoom() {
            try {
            // Ensure we have a selected row; if not, try to read it from the select element (works with Select2)
            if (!currentSelectedRow) {
                const sel = rowSelect.value;
                if (sel === '' || sel === null || sel === undefined) {
                    errorDiv.textContent = 'No row selected to assign.';
                    setTimeout(() => { if (errorDiv.textContent === 'No row selected to assign.') errorDiv.textContent = ''; }, 2000);
                    return;
                }
                currentSelectedRow = spreadsheetData[sel];
            }
            // visible feedback: start
            errorDiv.textContent = `Assigning Row ${currentSelectedRow._rowNumber}...`;
            // choose target room: prefer active tab, otherwise default to first defined room
            let targetRoom = window.activeRoomTab || (rooms && rooms.length ? rooms[0] : null);
            if (!targetRoom) {
                errorDiv.textContent = 'No room available to assign to.';
                return;
            }
            // don't allow assigning to Unassigned via this button; pick first non-Unassigned if needed
            if (targetRoom === 'Unassigned') {
                const firstRoom = (rooms && rooms.length) ? rooms.find(r => r !== 'Unassigned') : null;
                if (firstRoom) targetRoom = firstRoom;
                else {
                    errorDiv.textContent = 'No room available to assign to.';
                    return;
                }
            }
            errorDiv.textContent = '';

            // get subsection from dropdown
            const subsectionSelect = document.getElementById('subsectionSelect');
            const targetSubsection = subsectionSelect ? (subsectionSelect.value || 'Subsection 1') : 'Subsection 1';

            // check if this row already exists in THIS SPECIFIC ROOM+SUBSECTION
            const existsExact = selectedItems.findIndex(it => it._rowNumber === currentSelectedRow._rowNumber && it.room === targetRoom && ((it.subsection || 'Subsection 1') === targetSubsection));
            if (existsExact === -1) {
                // doesn't exist in this room/subsection, so add it (allows same row in multiple rooms or subsections)
                const itemToAdd = { ...currentSelectedRow, room: targetRoom, subsection: targetSubsection };
                selectedItems.push(itemToAdd);
            }
            // if it already exists in this exact room, do nothing (prevent duplicates in same room)

            // ensure the assigned room becomes the active tab
            window.activeRoomTab = targetRoom;
            displaySelectedItems();

            // visible feedback: success
            errorDiv.textContent = `Added Row ${currentSelectedRow._rowNumber} â†’ ${targetRoom}`;
            setTimeout(() => { if (errorDiv.textContent.startsWith('Added Row')) errorDiv.textContent = ''; }, 2000);

            currentSelectedRow = null;
            rowDetails.classList.remove('active');
            // don't clear rowSelect value; keep it so user can reassign to another room
            // rowSelect.value = '';
            // keep roomSelect as-is (user might still want to use it)
            // don't disable the button; keep it enabled for next selection
            saveState();
            } catch (err) {
                console.error('handleAssignToCurrentRoom ERROR:', err);
                errorDiv.textContent = 'Error: ' + (err && err.message ? err.message : String(err));
            }
        }

        function displaySelectedItems() {
            exportBtn.disabled = selectedItems.length === 0;

            selectedItemsSection.classList.add('active');
            const roomTabs = document.getElementById('roomTabs');
            const roomTabContent = document.getElementById('roomTabContent');
            roomTabs.innerHTML = '';
            roomTabContent.innerHTML = '';

            const grouped = {};
            rooms.forEach(r => grouped[r] = []);
            grouped['Unassigned'] = [];

            selectedItems.forEach((it, idx) => {
                const key = it.room && grouped[it.room] ? it.room : 'Unassigned';
                grouped[key].push({ item: it, originalIndex: idx });
            });

            const roomNames = Object.keys(grouped);

            // preserve previously active tab if possible
            if (!window.activeRoomTab || !roomNames.includes(window.activeRoomTab)) {
                const roomWithItems = roomNames.find(r => grouped[r] && grouped[r].length > 0);
                window.activeRoomTab = roomWithItems || roomNames[0] || 'Unassigned';
            }

            roomNames.forEach(roomName => {
                const count = grouped[roomName] ? grouped[roomName].length : 0;
                const btn = document.createElement('button');
                btn.className = 'room-tab-btn';
                btn.setAttribute('type', 'button');
                btn.dataset.room = roomName;
                btn.textContent = roomName + (count ? ` (${count})` : '');
                if (roomName === window.activeRoomTab) btn.classList.add('active');
                roomTabs.appendChild(btn);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'room-section';
                contentDiv.dataset.room = roomName;
                contentDiv.style.display = roomName === window.activeRoomTab ? 'block' : 'none';

                const title = document.createElement('div');
                title.className = 'room-title';
                title.textContent = roomName;
                contentDiv.appendChild(title);

                const items = grouped[roomName] || [];
                if (!items || items.length === 0) {
                    const emptyNote = document.createElement('div');
                    emptyNote.style.color = '#888';
                    emptyNote.style.fontSize = '13px';
                    emptyNote.style.padding = '8px 0';
                    emptyNote.textContent = 'No items yet.';
                    contentDiv.appendChild(emptyNote);
                } else {
                    // Group items by subsection
                    const subsectionGroups = {};
                    items.forEach(({ item }) => {
                        const subsection = item.subsection || 'Subsection 1';
                        if (!subsectionGroups[subsection]) {
                            subsectionGroups[subsection] = [];
                        }
                        subsectionGroups[subsection].push({ item, originalIndex: items.find(x => x.item === item).originalIndex });
                    });

                    // Display each subsection with header
                    Object.keys(subsectionGroups).sort().forEach(subsection => {
                        const subsectionHeader = document.createElement('div');
                        subsectionHeader.style.fontWeight = '600';
                        subsectionHeader.style.color = '#667eea';
                        subsectionHeader.style.marginTop = '12px';
                        subsectionHeader.style.marginBottom = '8px';
                        subsectionHeader.style.fontSize = '13px';
                        subsectionHeader.textContent = subsection;
                        contentDiv.appendChild(subsectionHeader);

                        subsectionGroups[subsection].forEach(({ item }) => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'selected-item';

                            const content = document.createElement('div');
                            content.className = 'selected-item-content';

                            const summary = document.createElement('div');
                            summary.className = 'selected-item-summary';
                            const displayValues = headers.slice(0, 3).map(h => item[h]).filter(v => v !== '');
                            summary.textContent = `Row ${item._rowNumber}: ${displayValues.join(' - ')}`;

                            const details = document.createElement('div');
                            details.className = 'selected-item-details';
                            details.textContent = headers.map(h => `${h}: ${item[h]}`).join(' | ');

                            content.appendChild(summary);
                            content.appendChild(details);

                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'delete-btn';
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.onclick = () => deleteSelectedItem(item._rowNumber, item.room, item.subsection);

                            itemDiv.appendChild(content);
                            itemDiv.appendChild(deleteBtn);
                            contentDiv.appendChild(itemDiv);
                        });
                    });
                }

                roomTabContent.appendChild(contentDiv);
            });

            // tab switching
            roomTabs.onclick = function (e) {
                const btn = e.target.closest('button.room-tab-btn');
                if (!btn) return;
                const newRoom = btn.dataset.room;
                if (!newRoom) return;
                if (newRoom === window.activeRoomTab) return;
                // update buttons
                Array.from(roomTabs.children).forEach(b => b.classList.toggle('active', b.dataset.room === newRoom));
                // show/hide content
                Array.from(roomTabContent.children).forEach(div => {
                    div.style.display = div.dataset.room === newRoom ? 'block' : 'none';
                });
                window.activeRoomTab = newRoom;
            };
        }

        function deleteSelectedItem(rowNumber, room, subsection) {
            const matchSub = subsection || 'Subsection 1';
            const idx = selectedItems.findIndex(it => it._rowNumber === rowNumber && it.room === room && ((it.subsection || 'Subsection 1') === matchSub));
            if (idx !== -1) {
                selectedItems.splice(idx, 1);
                displaySelectedItems();
                saveState();
                return;
            }
            // fallback: if exact match not found, remove first item with that rowNumber
            const fallback = selectedItems.findIndex(it => it._rowNumber === rowNumber);
            if (fallback !== -1) {
                selectedItems.splice(fallback, 1);
                displaySelectedItems();
                saveState();
            }
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Initialize Select2 after jQuery and Select2 are loaded
        $('#rowSelect').select2({
            placeholder: 'Search for a row...',
            allowClear: true,
            width: '100%'
        });
        $('#roomSelect').select2({
            placeholder: 'Search for a room...',
            allowClear: true,
            width: '100%'
        });
    </script>
</body>